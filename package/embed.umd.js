(function(n,r){typeof exports=="object"&&typeof module<"u"?module.exports=r():typeof define=="function"&&define.amd?define(r):(n=typeof globalThis<"u"?globalThis:n||self,n.RC=r())})(this,function(){"use strict";const n={EXPIRED:"expired",INIT_ERROR:"initError"};class r{instanceId;containerId;accessToken;container=null;eventListeners={};isInitialized=!1;initTime=null;iframe=null;messageHandler=null;constructor(e,t){this.containerId=e,this.accessToken=t,this.instanceId=this.generateInstanceId(),console.log(`RC 实例创建 [${this.instanceId}]:`,{containerId:e})}generateInstanceId(){return"rc_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}createEvent(e,t,s=null,h=null){return{type:e,message:t,code:s,timestamp:Date.now(),instanceId:this.instanceId,data:h}}emitEvent(e,t,s=null,h=null){const a=this.eventListeners[e];if(!a||a.length===0)return;const d=this.createEvent(e,t,s,h);a.forEach((l,f)=>{try{l.handler(d),l.once&&a.splice(f,1)}catch(I){console.error(`RC[${this.instanceId}] 事件处理器执行错误 [${e}]:`,I)}})}createContainer(e){const t=document.getElementById(e);return t?(t.innerHTML="",t.style.position="relative",t.style.overflow="hidden",t.setAttribute("data-rc-instance",this.instanceId),t):(this.emitEvent(n.INIT_ERROR,`找不到容器元素: ${e}`,"CONTAINER_NOT_FOUND"),null)}async initializeComponent(){try{this.isInitialized=!0,this.initTime=Date.now();const e=document.createElement("iframe");e.src=this.accessToken,e.style.width="100%",e.style.height="100%",e.style.border="none",this.iframe=e,this.setupMessageListener(),this.container.appendChild(e),console.log(`RC[${this.instanceId}] 组件初始化成功`)}catch(e){throw this.emitEvent(n.INIT_ERROR,`组件初始化失败: ${e.message}`,"INIT_FAILED"),e}}async start(){try{if(!this.containerId||typeof this.containerId!="string")throw this.emitEvent(n.INIT_ERROR,"containerId 必须是非空字符串","INVALID_CONTAINER_ID"),new Error("Invalid containerId");if(this.container=this.createContainer(this.containerId),!this.container)throw new Error("Container creation failed");return await this.initializeComponent(),this}catch(e){throw this.emitEvent(n.INIT_ERROR,`初始化异常: ${e.message}`,"INIT_EXCEPTION"),console.error(`RC[${this.instanceId}] 初始化失败:`,e),e}}on(e,t){if(typeof t!="function")throw new Error("事件处理器必须是函数");return this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push({handler:t,once:!1}),this}off(e,t){return this.eventListeners[e]?(t?(this.eventListeners[e]=this.eventListeners[e].filter(s=>s.handler!==t),this.eventListeners[e].length===0&&delete this.eventListeners[e]):delete this.eventListeners[e],this):this}once(e,t){if(typeof t!="function")throw new Error("事件处理器必须是函数");return this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push({handler:t,once:!0}),this}destroy(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.container&&(this.container.innerHTML="",this.container.removeAttribute("data-rc-instance")),this.eventListeners={},this.isInitialized=!1,this.iframe=null,window.RC_INSTANCES&&window.RC_INSTANCES[this.instanceId]&&delete window.RC_INSTANCES[this.instanceId],console.log(`RC[${this.instanceId}] 实例已销毁`)}getInfo(){return{instanceId:this.instanceId,containerId:this.containerId,isInitialized:this.isInitialized,initTime:this.initTime,eventListenerCount:Object.keys(this.eventListeners).length}}isReady(){return this.isInitialized}setupMessageListener(){const e=t=>{t.source===this.iframe?.contentWindow&&this.handleIframeMessage(t.data)};window.addEventListener("message",e),this.messageHandler=e}handleIframeMessage(e){try{const t=typeof e=="string"?JSON.parse(e):e;switch(console.log(`RC[${this.instanceId}] 收到iframe消息:`,t),t.type){case"token-expired":this.emitEvent(n.EXPIRED,t.message||"Token已过期",t.code,t.data);break;case"iframe-ready":console.log(`RC[${this.instanceId}] iframe内容已就绪`);break;case"height-change":t.height&&this.iframe&&(this.iframe.style.height=t.height+"px");break;default:console.log(`RC[${this.instanceId}] 未知消息类型:`,t.type)}}catch(t){console.error(`RC[${this.instanceId}] 处理iframe消息时出错:`,t)}}sendMessageToIframe(e){this.iframe?.contentWindow&&this.iframe.contentWindow.postMessage(e,"*")}}const o=window.RC_INSTANCES||{},c={EVENTS:n,init:async function(i,e){const t=new r(i,e);o[t.instanceId]=t;try{return await t.start(),t}catch(s){throw delete window.RC_INSTANCES[t.instanceId],s}},getAllInstances:function(){return o||{}},getInstance:function(i){return o[i]||null},destroyAll:function(){Object.values(o||{}).forEach(i=>{i.destroy()}),window.RC_INSTANCES={}},getEventNames:function(){return Object.values(n)},isValidEvent:function(i){return Object.values(n).indexOf(i)!==-1},getUrl:function(i){const e=o[i];return e&&e.iframe?.src||""}};return window.addEventListener("beforeunload",function(){c.destroyAll()}),console.log("RC 组件库已加载完成 (实例化模式)"),console.log("可用事件:",c.getEventNames()),c});
