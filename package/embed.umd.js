(function(n,r){typeof exports=="object"&&typeof module<"u"?module.exports=r():typeof define=="function"&&define.amd?define(r):(n=typeof globalThis<"u"?globalThis:n||self,n.RC=r())})(this,function(){"use strict";const n={EXPIRED:"expired",INIT_ERROR:"initError"};class r{instanceId;containerId;accessToken;container=null;eventListeners={};isInitialized=!1;initTime=null;iframe=null;messageHandler=null;showMenu=!1;constructor(e,t,i){this.containerId=e,this.accessToken=t,this.instanceId=this.generateInstanceId(),this.showMenu=i}generateInstanceId(){return"rc_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}createEvent(e,t,i=null,s=null){return{type:e,message:t,code:i,timestamp:Date.now(),instanceId:this.instanceId,data:s}}emitEvent(e,t,i=null,s=null){const o=this.eventListeners[e];if(!o||o.length===0)return;const d=this.createEvent(e,t,i,s);o.forEach((h,l)=>{try{h.handler(d),h.once&&o.splice(l,1)}catch(I){console.error(`RC[${this.instanceId}] 事件处理器执行错误 [${e}]:`,I)}})}createContainer(e){const t=document.getElementById(e);return t?(t.innerHTML="",t.style.position="relative",t.style.overflow="hidden",t.setAttribute("data-rc-instance",this.instanceId),t):(this.emitEvent(n.INIT_ERROR,`找不到容器元素: ${e}`,"CONTAINER_NOT_FOUND"),null)}initializeComponent(){try{this.isInitialized=!0,this.initTime=Date.now(),this.setupMessageListener();const e=document.createElement("iframe");e.src=this.accessToken+(this.showMenu?"&show_menu=true":""),e.style.width="100%",e.style.height="100%",e.style.border="none",this.iframe=e,this.container.appendChild(e)}catch(e){throw this.emitEvent(n.INIT_ERROR,`组件初始化失败: ${e.message}`,"INIT_FAILED"),e}}start(){try{if(!this.containerId||typeof this.containerId!="string")throw this.emitEvent(n.INIT_ERROR,"containerId 必须是非空字符串","INVALID_CONTAINER_ID"),new Error("Invalid containerId");if(this.container=this.createContainer(this.containerId),!this.container)throw new Error("Container creation failed");return this.initializeComponent(),this}catch(e){throw this.emitEvent(n.INIT_ERROR,`初始化异常: ${e.message}`,"INIT_EXCEPTION"),console.error(`RC[${this.instanceId}] 初始化失败:`,e),e}}on(e,t){if(typeof t!="function")throw new Error("事件处理器必须是函数");return this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push({handler:t,once:!1}),this}destroy(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.container&&(this.container.innerHTML="",this.container.removeAttribute("data-rc-instance")),this.eventListeners={},this.isInitialized=!1,this.iframe=null,window.RC_INSTANCES&&window.RC_INSTANCES[this.instanceId]&&delete window.RC_INSTANCES[this.instanceId],console.log(`RC[${this.instanceId}] 实例已销毁`)}getInfo(){return{instanceId:this.instanceId,containerId:this.containerId,isInitialized:this.isInitialized,initTime:this.initTime,eventListenerCount:Object.keys(this.eventListeners).length}}isReady(){return this.isInitialized}setupMessageListener(){const e=t=>{["5174","embed-console.rongcloud"].some(s=>t.origin.includes(s))&&this.handleIframeMessage(t.data)};window.addEventListener("message",e),this.messageHandler=e}handleIframeMessage(e){try{const t=typeof e=="string"?JSON.parse(e):e;switch(t.type){case n.EXPIRED:console.log("token expired"),this.emitEvent(n.EXPIRED,t.message||"Token已过期");break;case"iframe-ready":console.log(`RC[${this.instanceId}] iframe内容已就绪`);break;case"height-change":t.height&&this.iframe&&(this.iframe.style.height=t.height+"px");break}}catch{}}sendMessageToIframe(e){this.iframe?.contentWindow&&this.iframe.contentWindow.postMessage(e,"*")}}const c=window.RC_INSTANCES||{};return{EVENTS:n,init:function(a,e,t=!1){const i=new r(a,e,t);c[i.instanceId]=i;try{return i.start(),i}catch(s){throw delete window.RC_INSTANCES[i.instanceId],s}},getInstance:function(a){return c[a]||null},getEventNames:function(){return Object.values(n)}}});
